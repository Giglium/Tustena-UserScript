// ==UserScript==
// @name tustena
// @version 1.0.0
// @author Giglium
// @description A script that populates an intervention report on Tustena CRM
// @homepage https://github.com/Giglium/Tustena-UserScript
// @supportURL https://github.com/Giglium/Tustena-UserScript/issues
// @namespace https://github.com/Giglium/Tustena-UserScript
// @icon http://www.tustena.com/favicon.ico
// @run-at document-idle
// @grant none
// @noframes 
// @include <tustena-url>
// ==/UserScript==

(()=>{function e(){document.querySelector("#k-modal").style.display="block"}function t(){document.querySelector("#k-modal").style.display="none"}!function(){"use strict";var o,a;window.clients=window.clients||[],o=document.head||document.getElementsByTagName("head")[0],a=document.createElement("style"),o.appendChild(a),a.appendChild(document.createTextNode(".fab{width:50px;height:50px;background-color:red;border-radius:50%;box-shadow:0 6px 10px 0 #666;transition:all .1s ease-in-out;font-size:35px;color:#fff;text-align:center;line-height:50px;position:fixed;right:50px;bottom:50px}.fab:hover{box-shadow:0 6px 14px 0 #666;transform:scale(1.05)}.modal{display:none;position:fixed;z-index:20;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:#000;background-color:rgba(0,0,0,.4)}.modal-content{background-color:#fefefe;margin:15% auto;padding:20px;border:1px solid #888;width:50%}.close{color:#aaa;float:right;font-size:28px;font-weight:700}.close:focus,.close:hover{color:#000;text-decoration:none;cursor:pointer}.loader{border:16px solid #f3f3f3;border-radius:50%;border-top:16px solid #3498db;width:120px;height:120px;position:fixed;z-index:9999;left:50%;top:50%;-webkit-animation:spin 2s linear infinite;animation:spin 2s linear infinite}@-webkit-keyframes spin{0%{-webkit-transform:rotate(0)}100%{-webkit-transform:rotate(360deg)}}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}"));var i=document.createElement("div");i.className="fab",i.innerText="+";var n="";window.clients.forEach((function(e,t){n+='<option value="'+t+'">'+e.alias+"</option>"}));var r="";r=""!==n?document.createRange().createContextualFragment('<div id="k-modal" class="modal">  <div class="modal-content">    <span class="close">&times;</span>    <form id="k-form" autocomplete="off">       <label htmlFor="k-client">Choose a Client:</label>       <select name="client" id="k-company">'+n+'       </select>       <label htmlFor="k-date">Choose a Date:</label>       <input id="k-date" type="date">       <div>           <label htmlFor="k-start">Choose a start time:</label>           <input type="time" id="k-start" name="k-start" value="09:00:00" step="60">           <label htmlFor="k-end">Choose a end time:</label>           <input type="time" id="k-end" name="k-start" value="18:00:00" step="60">       </div>           <input type="checkbox" id="k-lunch" name="lunch" value="yes" checked="checked">           <label htmlFor="k-lunch">Subtract one hour for lunch</label>       <div><input type="submit" value="Create Voucher"></div>   </form>  </div></div>'):document.createRange().createContextualFragment('<div id="k-modal" class="modal">  <div class="modal-content">    <span class="close">&times;</span>   <div>No clients found, please update the scripts with the clients array</div>  </div></div>');var l=document.getElementsByTagName("body")[0];l.appendChild(i),l.appendChild(r);var d=(r=document.querySelector("#k-modal")).getElementsByTagName("span")[0];if(i.addEventListener("click",e),d.addEventListener("click",t),window.addEventListener("click",(function(e){e.target===r&&t()})),""!==n){var c=document.querySelector("#k-form");c.querySelector("#k-date").value=(new Date).toISOString().substring(0,10),c.addEventListener("submit",(function(e){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),t(),function(){var e=new Date(document.querySelector("#k-date").value),t=e,o="/Common/PopEditActivity.aspx?m=25&si=38&linknew=12&isoStart="+e.toISOString()+"&isoEnd="+t.toISOString()+"&allDay="+!0;o=TustenaCalendar.getLinkForNewActivity(12,"Voucher Intervento",o),TustenaCalendar.createDynaBox(o);var a=window.clients[document.querySelector("#k-company").value],i=document.createElement("div");i.className="loader";var n=document.getElementsByTagName("body")[0];n.appendChild(i),setTimeout((function(){var e=new Event("change"),t=new Event("click"),o=new Event("keydown"),r=document.querySelector("#dynaframe"),l=r.contentDocument||r.contentWindow.document,d=l.querySelector("#S_ActivityEdit_S_PredefinedTitleSelector_S_HybridSubject"),c=l.querySelector("#S_ActivityEdit_Activity_ToDo_0"),s=l.querySelector("#Free_S_ActivityEdit_S_FreeFields_Brand"),u=l.querySelector("#Free_S_ActivityEdit_S_FreeFields_TipoAttivit√†"),m=l.querySelector("#S_ActivityEdit_F_StartHour"),p=l.querySelector("#S_ActivityEdit_F_EndHour"),v=l.querySelector("#S_ActivityEdit_TextBoxDurationH"),y=l.querySelector("#S_ActivityEdit_TextBoxDurationM"),h=l.querySelector("#S_ActivityEdit_TextboxCompany"),f=l.querySelector("#S_ActivityEdit_TextboxDescription");d.value=a.title,c.checked=!0,c.dispatchEvent(t);var k=document.querySelector("#k-start").value,b=document.querySelector("#k-end").value,S=document.querySelector("#k-lunch").checked?1:0;m.value=k.slice(0,5),p.value=b.slice(0,5),p.dispatchEvent(e),k=k.split(":"),b=b.split(":");var x=new Date(0,0,0,k[0],k[1],0),g=new Date(0,0,0,b[0],b[1],0).getTime()-x.getTime(),w=Math.floor(g/1e3/60/60);g-=1e3*w*60*60;var _=Math.floor(g/1e3/60);v.value=w-S,y.value=_,f.value=a.description;for(var E=0,q=s.options.length;E<q;E++){var C=s.options[E];if(C.text===a.brand){C.selected="true";break}}for(var T=0,F=u.options.length;T<F;T++){var A=u.options[T];if(A.text===a.activity){A.selected="true";break}}h.value=a.company,h.dispatchEvent(o),n.removeChild(i)}),5e3)}()}))}}()})();